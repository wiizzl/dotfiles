#!/bin/bash

set -eufo pipefail

SOURCE_CACHE="$XDG_CACHE_HOME/vicinae-build"
FINAL_DEST="$XDG_DATA_HOME/vicinae/extensions"

{{ range .extensions.vicinae -}}
SRC="$SOURCE_CACHE/store.vicinae.{{ . }}"
DEST="$FINAL_DEST/store.vicinae.{{ . }}"
BUILD_OUTPUT="$SOURCE_CACHE/{{ . }}"

if [ -d "$SRC" ]; then
  cd "$SRC"

  bun install && bun run build > /dev/null

  if [ $? -eq 0 ]; then
    if [ -d "$BUILD_OUTPUT" ]; then
      mkdir -p "$DEST"
      rm -rf "${DEST:?}"/*
      cp -r "$BUILD_OUTPUT"/* "$DEST/"

      rm -rf "$SRC"
      rm -rf "$BUILD_OUTPUT"
    fi
  fi
fi
{{ end -}}